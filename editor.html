<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å›³é‘‘ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--line:#22314a;--text:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--accent2:#34d399}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#0b1222}
    header .left{display:flex;gap:10px;align-items:center}
    a.btn{display:inline-block;background:#0b1222;border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;text-decoration:none}
    a.btn:hover{background:#0f172a}
    a.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#031420}
    header h1{font-size:18px;margin:0}
    .wrap{display:grid;grid-template-columns: 1.2fr 1fr;gap:14px;max-width:1200px;margin:0 auto;padding:16px}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .panel h2{font-size:14px;margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#0f172a}
    .panel .body{padding:12px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .toolbar input[type="search"]{flex:1;min-width:180px}

    input,textarea,select,button{background:#0b1222;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px;outline:none}
    textarea{min-height:96px}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;font-weight:700;cursor:pointer}
    button.danger{background:#7f1d1d;border-color:#7f1d1d}
    .grid{display:grid;gap:8px}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    tr:hover{background:#0b122255}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#cbd5e1}
    .tags{font-size:12px;color:#cbd5e1}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .hint{font-size:12px;color:var(--muted)}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-grid label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    .form-grid label.full{grid-column:1/-1}

    .footer{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:10px}
    a.link{color:var(--accent)}
      /* ==== Live Preview Styles ==== */
    .preview{margin-top:12px}
    .pv-card{background:#111827;border:1px solid #22314a;border-radius:14px;overflow:hidden;box-shadow:0 8px 20px #0006}
    .pv-thumb{aspect-ratio:16/10;display:grid;place-items:center;background:#0b1222}
    .pv-thumb img{width:100%;height:100%;object-fit:cover}
    .pv-body{padding:12px;text-align:left}
    .pv-name{font-weight:800;margin:0 0 6px 0}
    .pv-meta{display:flex;gap:6px;flex-wrap:wrap;font-size:12px;color:#94a3b8}
    .pv-tag{border:1px solid #334155;padding:2px 8px;border-radius:999px}
    .pv-desc{font-size:13px;color:#cbd5e1;margin-top:8px;line-height:1.6}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <a class="btn" href="./index.html" title="å›³é‘‘ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹">â† å›³é‘‘ã¸æˆ»ã‚‹</a>
      <h1>å›³é‘‘ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ <span class="hint" id="status"></span></h1>
    </div>
    <div class="right">
      <button id="btnImport">JSONèª­ã¿è¾¼ã¿</button>
      <button id="btnDownload" class="primary">data.jsonã‚’æ›¸ãå‡ºã—</button>
    </div>
  </header>

  <div class="wrap">
    <!-- å·¦: ä¸€è¦§ -->
    <section class="panel">
      <h2>ä¸€è¦§</h2>
      <div class="body grid">
        <div class="toolbar">
          <input id="q" type="search" placeholder="æ¤œç´¢ï¼ˆåå‰ãƒ»èª¬æ˜ãƒ»ã‚¿ã‚°ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼‰" />
          <select id="sort">
            <option value="new">æ–°ã—ã„é †</option>
            <option value="name">åå‰é †</option>
          </select>
          <button id="btnNew" class="primary">æ–°è¦ä½œæˆ</button>
        </div>
        <div class="hint">ğŸ’¡ å³ä¸Šã®ã€Œdata.jsonã‚’æ›¸ãå‡ºã—ã€ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€GitHubã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨å…¬é–‹ãƒšãƒ¼ã‚¸ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:10ch">ID</th>
                <th>åå‰</th>
                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                <th>ã‚¿ã‚°</th>
                <th>æ›´æ–°æ—¥</th>
                <th style="width:170px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- å³: ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
    <section class="panel">
      <h2 id="formTitle">æ–°è¦ä½œæˆ</h2>
      <div class="body">
        <form id="form" class="grid form-grid" autocomplete="off">
          <label>
            <span>IDï¼ˆè‡ªå‹•ç”Ÿæˆæ¨å¥¨ï¼‰</span>
            <input id="f_id" placeholder="ç©ºãªã‚‰è‡ªå‹•æ¡ç•ª" />
          </label>
          <label>
            <span>åå‰ *</span>
            <input id="f_name" required />
          </label>
          <label>
            <span>ã‚«ãƒ†ã‚´ãƒª</span>
            <input id="f_category" />
          </label>
          <label>
            <span>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</span>
            <input id="f_tags" placeholder="ä¾‹: ã¿ã©ã‚Š, å°å‹" />
          </label>
          <label class="full">
            <span>èª¬æ˜ *</span>
            <textarea id="f_description" required></textarea>
          </label>
          <label class="full">
            <span>ç”»åƒURLï¼ˆä¾‹: images/frog.jpg ã¾ãŸã¯ https://â€¦ï¼‰</span>
            <input id="f_imageUrl" />
          </label>
          <label>
            <span>ã‚µã‚¤ã‚º</span>
            <input id="f_size" />
          </label>
          <label>
            <span>ç”Ÿæ¯åŸŸ</span>
            <input id="f_habitat" />
          </label>
          <label class="full">
            <span>ãƒ¡ãƒ¢</span>
            <input id="f_note" />
          </label>
          <label>
            <span>ä½œæˆæ—¥ï¼ˆYYYY-MM-DDï¼‰</span>
            <input id="f_createdAt" placeholder="ç©ºãªã‚‰ä»Šæ—¥" />
          </label>
          <div class="footer">
            <div class="hint">å¿…é ˆ: åå‰ãƒ»èª¬æ˜</div>
            <div class="right">
              <button type="button" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
              <button type="submit" class="primary">ä¿å­˜</button>
            </div>
          </div>
        </form>
        <div class="preview">
          <h3 style="margin:14px 0 8px;font-size:14px;color:#94a3b8">ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
          <div class="pv-card" id="pvCard">
            <div class="pv-thumb"><img id="pvImg" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ"></div>
            <div class="pv-body">
              <div class="pv-name" id="pvName">ï¼ˆåå‰ï¼‰</div>
              <div class="pv-meta">
                <span class="pv-tag" id="pvCategory">ã‚«ãƒ†ã‚´ãƒª</span>
                <span id="pvTags"></span>
              </div>
              <div class="pv-desc" id="pvDesc">ã“ã“ã«èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <input type="file" id="fileInput" accept="application/json" hidden />

  <script>
    // ===== çŠ¶æ…‹ =====
    /** @type {Array<any>} */
    let entries = [];
    let editingId = null; // ç¾åœ¨ç·¨é›†ä¸­ã®IDï¼ˆnull = æ–°è¦ï¼‰

    // ===== åˆæœŸåŒ– =====
    window.addEventListener('DOMContentLoaded', init);

    async function init(){
      setStatus('èª­ã¿è¾¼ã¿ä¸­â€¦');
      const restored = localStorage.getItem('zukan-editor');
      try{
        const res = await fetch('./data.json', { cache: 'no-store' });
        if(res.ok){ entries = await res.json(); setStatus('data.json ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ'); }
        else{ entries = []; setStatus(`data.json èª­ã¿è¾¼ã¿å¤±æ•—: HTTP ${res.status}`); }
      }catch(e){
        entries = restored ? JSON.parse(restored) : [];
        setStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¾ãŸã¯data.jsonæœªé…ç½®ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã®ä¸‹æ›¸ãã‚’åˆ©ç”¨ã—ã¾ã™');
      }
      if(!Array.isArray(entries)) entries = [];
      renderTable();
      bindUI();
    }

    function setStatus(msg){ document.getElementById('status').textContent = 'â€” ' + msg; }

    // ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
    function renderTable(){
      const q = document.getElementById('q').value?.trim().toLowerCase() || '';
      const sort = document.getElementById('sort').value || 'new';
      let list = entries.slice();
      if(q){
        list = list.filter(e => [e.name,e.description,e.category,(e.tags||[]).join(',')].join(' ').toLowerCase().includes(q));
      }
      if(sort==='name') list.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'ja'));
      if(sort==='new') list.sort((a,b)=> String(b.createdAt||'').localeCompare(String(a.createdAt||'')));

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = list.map(e => {
        const tags = (e.tags||[]).join(', ');
        return `<tr>
          <td class="mono">${escapeHtml(e.id||'')}</td>
          <td>${escapeHtml(e.name||'')}</td>
          <td>${escapeHtml(e.category||'')}</td>
          <td class="tags">${escapeHtml(tags)}</td>
          <td class="mono">${escapeHtml(e.createdAt||'')}</td>
          <td>
            <div class="right">
              <button data-act="edit" data-id="${escapeAttr(e.id)}">ç·¨é›†</button>
              <button data-act="dup" data-id="${escapeAttr(e.id)}">è¤‡è£½</button>
              <button class="danger" data-act="del" data-id="${escapeAttr(e.id)}">å‰Šé™¤</button>
            </div>
          </td>
        </tr>`;
      }).join('');

      tbody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', onRowAction);
      });

      localStorage.setItem('zukan-editor', JSON.stringify(entries));
    }

    function onRowAction(e){
      const act = e.currentTarget.dataset.act;
      const id = e.currentTarget.dataset.id;
      const item = entries.find(x => String(x.id) === String(id));
      if(!item) return;
      if(act==='edit') fillForm(item);
      if(act==='dup'){
        const copy = structuredClone(item);
        copy.id = genId();
        copy.name = item.name + 'ï¼ˆè¤‡è£½ï¼‰';
        entries.unshift(copy);
        renderTable();
        fillForm(copy);
      }
      if(act==='del'){
        if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
          entries = entries.filter(x => String(x.id) !== String(id));
          renderTable();
          if(editingId===id){ resetForm(); }
        }
      }
    }

    // ===== ãƒ•ã‚©ãƒ¼ãƒ  =====
    function fillForm(e){
      editingId = e.id;
      document.getElementById('formTitle').textContent = 'ç·¨é›†: ' + (e.name||'');
      f_id.value = e.id || '';
      f_name.value = e.name || '';
      f_category.value = e.category || '';
      f_tags.value = (e.tags||[]).join(', ');
      f_description.value = e.description || '';
      f_imageUrl.value = e.imageUrl || '';
      f_size.value = e.size || '';
      f_habitat.value = e.habitat || '';
      f_note.value = e.note || '';
      f_createdAt.value = e.createdAt || '';
      updatePreview();
    }

    function resetForm(){
      editingId = null;
      document.getElementById('formTitle').textContent = 'æ–°è¦ä½œæˆ';
      document.getElementById('form').reset();
      updatePreview();
    }

    function bindUI(){
      document.getElementById('q').addEventListener('input', renderTable);
      document.getElementById('sort').addEventListener('change', renderTable);
      document.getElementById('btnNew').addEventListener('click', ()=>{ resetForm(); updatePreview(); });
      document.getElementById('btnReset').addEventListener('click', ()=>{ resetForm(); updatePreview(); });

      document.getElementById('form').addEventListener('submit', ev =>{
        ev.preventDefault();
        const entry = collectForm();
        if(!entry.name || !entry.description){ alert('åå‰ã¨èª¬æ˜ã¯å¿…é ˆã§ã™'); return; }
        if(editingId){
          const idx = entries.findIndex(x => String(x.id) === String(editingId));
          if(idx>=0) entries[idx] = entry;
        }else{
          entries.unshift(entry);
        }
        renderTable();
        resetForm();
        updatePreview();
      });

      document.getElementById('btnDownload').addEventListener('click', downloadJson);
      document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', importJsonFromFile);

      // ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›ã«å¿œã˜ã¦ãƒ©ã‚¤ãƒ–æ›´æ–°
      document.querySelectorAll('#form input, #form textarea, #form select').forEach(el=>{
        el.addEventListener('input', updatePreview);
        el.addEventListener('change', updatePreview);
      });
      updatePreview();
    }
        if(editingId){
          const idx = entries.findIndex(x => String(x.id) === String(editingId));
          if(idx>=0) entries[idx] = entry;
        }else{
          entries.unshift(entry);
        }
        renderTable();
        resetForm();
      });

      document.getElementById('btnDownload').addEventListener('click', downloadJson);
      document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', importJsonFromFile);
    }

    function collectForm(){
      const id = (f_id.value ? String(f_id.value).trim() : genId());
      const entry = {
        id,
        name: f_name.value.trim(),
        category: f_category.value.trim(),
        description: f_description.value.trim(),
        tags: f_tags.value.split(',').map(s=>s.trim()).filter(Boolean),
        imageUrl: f_imageUrl.value.trim() || undefined,
        size: f_size.value.trim() || undefined,
        habitat: f_habitat.value.trim() || undefined,
        note: f_note.value.trim() || undefined,
        createdAt: (f_createdAt.value.trim() || new Date().toISOString().slice(0,10))
      };
      return entry;
    }

    function genId(){
      // æ—¢å­˜ã®æ•°å€¤IDã®æœ€å¤§å€¤ + 1 ã‚’è¿”ã™ï¼ˆæ•°å€¤ã§ãªã„IDã¯ç„¡è¦–ï¼‰
      return nextNumericId(entries);
    }

    function nextNumericId(list){
      const nums = list
        .map(e => Number(String(e?.id ?? '').trim()))
        .filter(n => Number.isFinite(n));
      const max = nums.length ? Math.max(...nums) : 0;
      let candidate = max + 1;
      // å¿µã®ãŸã‚ã€æ–‡å­—åˆ—æ¯”è¼ƒã§é‡è¤‡ã—ãªã„ã‚ˆã†ãƒã‚§ãƒƒã‚¯
      const idset = new Set(list.map(e => String(e?.id ?? '')));
      while(idset.has(String(candidate))){ candidate++; }
      return String(candidate);
    }

    function downloadJson(){
      const blob = new Blob([JSON.stringify(entries, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'data.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJsonFromFile(ev){
      const file = ev.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const json = JSON.parse(String(reader.result||'[]'));
          if(!Array.isArray(json)) throw new Error('é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
          entries = json;
          renderTable();
          resetForm();
          setStatus('ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰JSONã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        }catch(e){ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: '+e.message); }
      };
      reader.readAsText(file);
      // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
      ev.target.value = '';
    }

    // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function escapeHtml(s=''){return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}
    function escapeAttr(s=''){return String(s).replace(/"/g,'&quot;')}

    // ---- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ----
    function updatePreview(){
      const e = collectForm();
      const imgEl = document.getElementById('pvImg');
      const nameEl = document.getElementById('pvName');
      const catEl = document.getElementById('pvCategory');
      const tagsWrap = document.getElementById('pvTags');
      const descEl = document.getElementById('pvDesc');

      nameEl.textContent = e.name || 'ï¼ˆåå‰ï¼‰';
      catEl.textContent = e.category || 'æœªåˆ†é¡';
      descEl.textContent = e.description || 'ã“ã“ã«èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';

      const tags = (e.tags||[]).slice(0,3).map(t=>`<span class='pv-tag'>${escapeHtml(t)}</span>`).join('');
      tagsWrap.innerHTML = tags;

      if(e.imageUrl){
        imgEl.src = e.imageUrl;
        imgEl.alt = e.name || 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ';
      }else{
        imgEl.src = placeholderFromText(e.name||'');
        imgEl.alt = 'ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼';
      }
    }

    function placeholderFromText(text){
      const t = (text||'').slice(0,6) || 'Preview';
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 500'>
        <rect width='800' height='500' fill='#0b1222'/>
        <text x='50%' y='52%' text-anchor='middle' font-size='64' fill='#94a3b8' font-family='system-ui, sans-serif'>${escapeHtml(t)}</text>
      </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }
  </script>
</body>
</html>
