<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ミニ図鑑</title>
  <style>
    :root { --bg:#0b1020; --card:#131a33; --ink:#e6ebff; --muted:#94a3b8; --accent:#7c9cff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; background: var(--bg); color: var(--ink); }
    header { padding: 24px 16px; max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: 24px; }
    .toolbar { display:grid; gap:12px; grid-template-columns: 1fr minmax(220px, 320px); align-items: center; }
    .search { display:flex; gap:8px; }
    .search input { flex:1; padding:10px 12px; border-radius:12px; border:1px solid #26304f; background:#0f1530; color:var(--ink); outline:none; }
    .search input::placeholder { color: var(--muted); }
    .count { text-align:right; color: var(--muted); font-size:12px; }
    .tags { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .tag { padding:6px 10px; border-radius:999px; background:#0f1530; border:1px solid #243055; color: var(--muted); cursor:pointer; user-select:none; font-size:13px; }
    .tag.active { color:#0b1020; background: var(--accent); border-color: var(--accent); }
    main { max-width: 980px; margin: 8px auto 48px; padding: 0 16px; }
    .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .card { background: var(--card); border:1px solid #1c2444; border-radius:16px; padding:14px; transition: transform .08s ease, border-color .1s; }
    .card:hover { transform: translateY(-2px); border-color:#2b3a77; }
    .title { font-weight:700; margin:0 0 4px; }
    .category { font-size:12px; color: var(--muted); margin-bottom:8px; }
    .desc { font-size:14px; line-height:1.6; color:#cbd5e1; }
    .chiprow { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip { font-size:11px; padding:4px 8px; border-radius:999px; background:#0f1530; border:1px solid #243055; color:#aab3d1; }
    footer { max-width:980px; margin:24px auto; padding:0 16px; color:var(--muted); font-size:12px; }
    @media (max-width:640px){ .toolbar{ grid-template-columns:1fr; } .count{text-align:left;} }
    #modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.65);
  z-index: 999;
}
#modal.show { display: flex; animation: fadein .2s ease; }
.modal-content {
  background: #131a33;
  padding: 20px;
  border-radius: 16px;
  max-width: 480px;
  width: 90%;
  color: #e6ebff;
  text-align: center;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  animation: pop .2s ease;
}
.modal-content img {
  width: 100%;
  border-radius: 12px;
  margin-bottom: 12px;
  border:1px solid #1c2444;
}
.modal-content h2 { margin: 0 0 8px; }
.modal-content p { line-height: 1.6; color: #cbd5e1; margin-bottom: 12px; }
@keyframes fadein { from {opacity:0;} to {opacity:1;} }
@keyframes pop { from {transform: scale(0.9);} to {transform: scale(1);} }
  </style>
</head>
<body>
  <header>
    <h1>ミニ図鑑</h1>
    <div class="toolbar">
      <div>
        <div class="search">
          <input id="qName" type="search" placeholder="名前で検索（例：キツネ）" aria-label="名前検索" />
          <input id="qTag"  type="search" placeholder="タグで検索（カンマ区切り）例：夜行性,小型" aria-label="タグ検索" />
        </div>
        <div id="tagCloud" class="tags" aria-label="利用可能なタグ"></div>
      </div>
      <div class="count"><span id="count"></span></div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <footer>
    data.json を編集して保存すると、ページ読み込み時に自動で反映されます。
  </footer>

<script>
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  let DATA = [];
  let ACTIVE_TAGS = new Set();

  function renderCards(list){
    const grid = $("#grid");
    grid.innerHTML = list.map((item, i) => {
      const tags = (item.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("");
      const imgPath = item.image && item.image.trim() ? item.image : "images/no_image_logo.png";
      const img = `<img src="${escapeAttr(imgPath)}" alt="${escapeAttr(item.name)}"
        style="width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:10px;margin-bottom:8px;border:1px solid #1c2444;"
        onerror="this.src='images/no_image_logo.png';" />`;
      return `
        <article class="card" tabindex="0" data-index="${i}">
          ${img}
          <h3 class="title">${escapeHtml(item.name)}</h3>
          <p class="desc">${escapeHtml(item.description || "")}</p>
          <div class="chiprow">${tags}</div>
        </article>
      `;
    }).join("");

    $("#count").textContent = `${list.length} 件表示 / 全 ${DATA.length} 件`;

    // カードクリックでモーダル表示
    $$(".card").forEach(card=>{
      card.addEventListener("click", ()=>{
        const idx = parseInt(card.dataset.index);
        showModal(list[idx]);
      });
    });
  }

  function renderTagCloud(allTags){
    const tagCloud = $("#tagCloud");
    tagCloud.innerHTML = Array.from(allTags)
      .sort((a,b)=>a.localeCompare(b,'ja'))
      .map(tag => `<button class="tag" data-tag="${escapeAttr(tag)}">${escapeHtml(tag)}</button>`)
      .join("");
    $$("#tagCloud .tag").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const t = btn.dataset.tag;
        if (ACTIVE_TAGS.has(t)) { ACTIVE_TAGS.delete(t); btn.classList.remove("active"); }
        else { ACTIVE_TAGS.add(t); btn.classList.add("active"); }
        applyFilters();
      });
    });
  }

  function applyFilters(){
    const nameQ = $("#qName").value.trim().toLowerCase();
    const typedTags = $("#qTag").value.split(",").map(s=>s.trim()).filter(Boolean);
    const allActive = new Set([...ACTIVE_TAGS, ...typedTags]);
    const filtered = DATA.filter(item=>{
      const okName = !nameQ || (item.name||"").toLowerCase().includes(nameQ);
      const okTags = allActive.size === 0 || [...allActive].every(t => (item.tags||[]).includes(t));
      return okName && okTags;
    });
    renderCards(filtered);
  }

  function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function escapeAttr(s){ return String(s).replaceAll("&","&amp;").replaceAll("\"","&quot;"); }

  async function init(){
    const res = await fetch("data.json", { cache:"no-store" });
    if (!res.ok) { $("#grid").innerHTML = `<p>data.json 読み込み失敗 (${res.status})</p>`; return; }
    DATA = await res.json();
    const allTags = new Set();
    DATA.forEach(it => (it.tags||[]).forEach(t => allTags.add(t)));
    renderTagCloud(allTags);
    $("#qName").addEventListener("input", debounce(applyFilters, 120));
    $("#qTag").addEventListener("input", debounce(applyFilters, 120));
    applyFilters();
  }

  // ===== モーダル処理 =====
  function showModal(item){
    const modal = $("#modal");
    const imgPath = item.image && item.image.trim() ? item.image : "images/no_image_logo.png";
    modal.innerHTML = `
      <div class="modal-bg"></div>
      <div class="modal-content">
        <img src="${escapeAttr(imgPath)}" alt="${escapeAttr(item.name)}" onerror="this.src='images/no_image_logo.png';" />
        <h2>${escapeHtml(item.name)}</h2>
        <p>${escapeHtml(item.description || "")}</p>
        <div class="chiprow">${(item.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("")}</div>
      </div>
    `;
    modal.classList.add("show");
    modal.querySelector(".modal-bg").addEventListener("click", ()=> modal.classList.remove("show"));
  }

  init();
</script>
<div id="modal"></div>
</body>
</html>
